{% extends 'sandbox/base.html' %}
{% load static %}
{% block content %}
<form class="js-form">
  <input type="text" class="js-username" placeholder="username" required">
  <input type="password" class="js-password" placeholder="password" required>
  <button type="submit">go</button>
</form>
{% endblock %}
{% block scripts %}
<script src="{% static 'sandbox' %}/js/lib/utils.js"></script>
<script src="{% static 'sandbox' %}/js/lib/api.js"></script>
<script src="{% static 'sandbox' %}/js/CurrentTranscript.js"></script>
<script>

 window.onload = function () {
   var formNode = document.querySelector('.js-form');

   formNode.style.display = 'none';

   formNode.addEventListener('submit', function (evt) {
     evt.preventDefault();
     runTest();
   }, false);

   API.getInstance().then(function (api) {
     api.checkSession().then(function () {
       test();
     }, function () {
       formNode.style.display = 'block';
     });
   });

 };

 function runTest () {

   API.getInstance().then(function (api) {

     var c = getCredentials();

     var p = api.login(c.username, c.password);
     p.catch(function (error) {

       document.body.insertBefore(document.createTextNode("Invalid password"), document.body.lastElementChild);

       console.error(error);
     });

     p.then(test);

   });
 }

 function getCredentials () {
   var formNode = document.querySelector('.js-form');
   var usernameNode = formNode.querySelector('.js-username');
   var passwordNode = formNode.querySelector('.js-password');

   return {
     username: usernameNode.value,
     password: passwordNode.value
   };

 }

 function test () {

   var t = new CurrentTranscript(2305, 36784, 1);

   t.load().then(function (u) {
     console.debug('done');

     console.assert(t === u);

     console.log({
       image: t.getImageUrl(),
       xml: t.getPageXml(),
     });

     document.body.appendChild(document.createTextNode("Done!"));

   }, function (error) {
     console.error("There has been an error:", error);
     document.body.appendChild(document.createTextNode("Error!"));
   });

   CurrentTranscript.load(2305, 36784, 1).then(function (t) {
     console.log({t: t});
     console.log({
       image: t.getImageUrl(),
       xml: t.getPageXml(),
     });

   });

 }
</script>
{% endblock %}
