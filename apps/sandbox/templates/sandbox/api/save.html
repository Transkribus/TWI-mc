{% extends 'sandbox/base.html' %}
{% load static %}
{% block content %}
<button value="change">change</button>
<button value="print">print</button>
<div class="text js-text"></div>
{% endblock %}
{% block scripts %}
<script src="{% static 'sandbox' %}/js/lib/utils.js"></script>
<script src="{% static 'sandbox' %}/js/lib/api.js"></script>
<script src="{% static 'sandbox' %}/js/CurrentTranscript.js"></script>
<script>
 var colId = 1989;
 var docId = 3919
 var pageNr = 1;

 window.onload = function (evt) {

   var p = new URLSearchParams(document.location.search);

   var username = p.get('username');
   var password = p.get('password');

   if ([username, password].indexOf(null) >= 0)
     alert("Missing username or password.");

   API.getInstance().then(function (api) {

     api.login(username, password);

     api.isPageLocked(colId, docId, pageNr).then(function (data) {
       console.log('isPageLocked', data);

       api.listPageLocks(colId, docId, pageNr).then(function (data) {
         console.log('listPageLocks', data);

         api.lockPage(colId, docId, pageNr, true).then(function (data) {
           console.log('lockPage', data);

           api.listPageLocks(colId, docId, pageNr).then(function (data) {
             console.log('listPageLocks', data);

             api.isPageLocked(colId, docId, pageNr).then(function (data) {
               console.log('isPageLocked', data);
               api.lockPage(colId, docId, pageNr, false).then(function (data) {
                 console.log('lockPage', data);
               });

             });

           });


         });

       });


     });
   });

   var buttons = Array.from(document.querySelectorAll('button'));

   var printNode = document.querySelector('button[value="print"]');
   printNode.addEventListener('click', function (evt) {
     evt.preventDefault();

     run(processPrint, false);

   }, false);

   var changeNode = document.querySelector('button[value="change"]');
   changeNode.addEventListener('click', function (evt) {
     evt.preventDefault();

     textNode.innerHTML = '';

     run(processChange, true);

   }, false);

 };

 function disableButtons () {
   buttons.forEach(function (node) {
     node.setAttribute('disabled', '');
   });
 }

 function enableButtons ( ) {
   buttons.forEach(function (node) {
     node.removeAttribute('disabled');
   });
 }

 var S = ['moo', 'bark', 'meow', 'purr', 'hiss', 'gobble', 'oink', 'bugle', 'bleat'];
 
 var textNode = document.querySelector('.js-text');
 function processPrint (node) {
   textNode.appendChild(document.createTextNode(node.textContent));
   textNode.appendChild(document.createElement('br'));
 };

 function processChange (node) {
   var tokens = node.textContent.split(' ');
   var newTokens = [];
   for (var index = 0; index < tokens.length; index++) {
     newTokens.push(getRandomAnimalSound());
   }
   node.textContent = newTokens.join(' ');
 }

 function getRandomAnimalSound () {
   return S[Math.floor(Math.random() * S.length)];
 }

 function run (processUnicode, mustSave) {

   var t = new CurrentTranscript(colId, docId, pageNr);

   t.isLocked().then(function (isLocked) {
     console.log('isLocked', isLocked);
   });

   t.load().then(function (t) {

     var doc = t.getPageDoc();
     var root = t.getPageRoot();

     process(root);

     if (mustSave === true)
       t.save({status: 'FINAL'});

     function process (node) {

       if (node.nodeName === 'Unicode' && node.parentNode.parentNode.nodeName === 'TextLine')
         processUnicode(node);

       var nodeList = Array.from(node.children);
       for (var index = 0; index < nodeList.length; index++) {
         process(nodeList[index]);
       }
     }

   });
 }
</script>
{% endblock %}
